<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.let.rsv.service.impl.ReservationMapper">
	
	<select id="selectReservationList" resultType="egovMap">
		SELECT
			A.RESVE_ID
			, A.RESVE_SE_CODE
			, A.RESVE_SJ
			, A.REC_NM
			, A.MAX_APLY_CNT
			, A.USE_BEGIN_DT
			, A.USE_END_DT
			, A.USE_BEGIN_TIME
			, A.USE_END_TIME
			, A.RESVE_CN
			, A.REQST_BGNDE
			, A.REQST_ENDDE
			, A.USE_AT
			, A.FRST_REGIST_PNTTM
			, A.FRST_REGISTER_ID
			, (SELECT
				 COUNT(*)
			   FROM RESVEREQSTINFO B
			   WHERE A.RESVE_ID = B.RESVE_ID) AS APPLY_CNT
			<![CDATA[
			, CASE WHEN DATE_FORMAT(NOW(), '%Y-&m-&d') < A.REQST_BGNDE THEN 1
				   WHEN DATE_FORMAT(NOW(), '%Y-&m-&d') >= A.REQST_BGNDE AND DATE_FORMAT(NOW(), '%Y-&m-&d') <= A.REQST_ENDDE THEN 2
				   WHEN DATE_FORMAT(NOW(), '%Y-&m-&d') > A.REQST_ENDDE AND DATE_FORMAT(NOW(), '%Y-&m-&d') < A.USE_BEGIN_DT THEN 3
				   WHEN DATE_FORMAT(NOW(), '%Y-&m-&d') >= A.USE_BEGIN_DT AND DATE_FORMAT(NOW(), '%Y-&m-&d') <= A.USE_END_DT THEN 4
					ELSE 5
			END AS APPLY_STATUS
			]]>
			, (SELECT
					COUNT(*)
				FROM RESVEREQSTINFO B
				WHERE A.RESVE_ID = B.RESVE_ID
					AND B.CONFM_SE_CODE = 'O') AS APPLY_F_CNT
			FROM RESVEINFO A
			<include refid="selectReservationListWhere"></include>
			ORDER BY A.FRST_REGIST_PNTTM DESC
			LIMIT #{recordCountPerPage} OFFSET #{firstIndex} 
	</select>
	
	<select id="selectReservationListCnt" resultType="java.lang.Integer">
		SELECT
			COUNT(*) CNT
		FROM RESVEINFO A		
		<include refid="selectReservationListWhere"></include>
	</select>
	
	<sql id="selectReservationListWhere">
		<where>
			A.USE_AT = 'Y'
		</where>
		<if test='searchCondition != null and searchCondition != ""'>
			<choose>
				 <when test='searchCondition == "0"'>
				 	AND A.RESVE_SJ LIKE CONCAT('%', #{searchKeyword}, '%')
				 </when>
				 <when test='searchCondition == "1"'>
				 	AND A.RESVE_CN LIKE CONCAT('%', #{searchKeyword}, '%')
			 	</when>
			</choose>
		</if>
		
		<if test='searchDate != null and searchDate != ""'>
			AMD (DATE_FORMAT(USE_BEGIN_DT, '%Y%m') = #{searchDate} OR DATE_FORMAT(USE_END_DT, '%Y%m') = #{searchDate})
		</if>
	</sql>
</mapper>